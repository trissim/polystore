name: Smoke Test

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Patch metaclass-registry
        run: |
          REGISTRY_INIT=$(python -c "import metaclass_registry, os; print(os.path.dirname(metaclass_registry.__file__))")/__init__.py
          cat > "$REGISTRY_INIT" << 'EOF'
          """metaclass-registry: Zero-boilerplate metaclass-driven plugin registry system."""
          __version__ = "0.1.0"
          from .core import AutoRegisterMeta, RegistryConfig, PRIMARY_KEY
          from .exceptions import RegistryError
          __all__ = ["AutoRegisterMeta", "RegistryConfig", "PRIMARY_KEY", "RegistryError"]
          EOF

      - name: Test basic imports
        run: |
          python -c "import polystore; print(f'✓ polystore {polystore.__version__}')"
          python -c "from polystore import FileManager, BackendRegistry, MemoryBackend, DiskBackend; print('✓ All imports work')"

      - name: Test basic functionality
        run: |
          python << 'PYEOF'
          import numpy as np
          from polystore import MemoryBackend
          
          backend = MemoryBackend()
          backend.ensure_directory("/")
          data = np.array([1, 2, 3])
          backend.save(data, "/test.npy")
          loaded = backend.load("/test.npy")
          assert np.array_equal(data, loaded)
          print("✓ Basic memory backend works")
          PYEOF
